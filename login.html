<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lawreay Log In</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root { --bg-start:#0b74de; --bg-end:#0a66c2; --card:#ffffff; --accent:#045bb5; --error:#d9534f; --muted:#475569; }
    html,body { height:100%; margin:0; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, var(--bg-start) 0%, var(--bg-end) 100%);
      display:flex; align-items:center; justify-content:center;
      margin-top: 16px;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      color:#0f172a;
    }
    .card { background:var(--card); padding:28px; border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.18); width:520px; max-width:94%; }
    h1 { margin:0 0 8px 0; font-size:20px; color:#0f172a; }
    label { display:block; font-size:13px; margin-bottom:6px; color:#0f172a; }
    input[type="text"] { width:100%; padding:10px 12px; border:1px solid #e6e9ef; border-radius:8px; font-size:15px; box-sizing:border-box; background:#fff; }
    .actions { margin-top:16px; display:flex; gap:8px; }
    button { flex:1; padding:10px 12px; border-radius:8px; border:0; background:var(--accent); color:#fff; font-weight:600; cursor:pointer; min-width:0; }
    .btn-secondary { background:#10111239; color:var(--accent); border:1px solid rgba(4,91,181,0.12); }
    .message { margin-top:12px; font-size:14px; min-height:20px; }
    .message.error { color:var(--error); }
    .message.success { color:green; }
    .hint { margin-top:10px; font-size:12px; color:var(--muted); }
    code { background:#f1f5f9; padding:2px 6px; border-radius:4px; font-family:monospace; }
    @media (max-width:480px){
      .card{padding:18px}
      .actions{flex-direction:column}
      .actions button{width:100%}
    }
  </style>
</head>
<body>

    

  <main class="card" role="main" aria-labelledby="title">
     <h1>Welcome to Lawreay HTML &amp; CSS Fundamentals</h1>
      <div class="subtitle">Start: 15 Dec · Time: 14:00–16:30 CAT · In-person + Livestream</div>
    
    <h1 id="title">Enter Invitation Code</h1>
    <p>Enter your name and the invitation code.</p>

    <form id="inviteForm" autocomplete="off" novalidate>

      <label for="name">Your name</label>
      <input id="name" name="name" type="text" inputmode="text" aria-describedby="nameHintForm" required />

      <label for="code" style="margin-top:12px;">Invitation code</label>
      <input id="code" name="code" type="text" inputmode="text" aria-describedby="codeHintForm" required />

      <div class="actions">
        <button type="submit">Verify</button>
        <button type="button" class="btn-secondary" id="clearBtn">Clear</button>
      </div>

      <div id="message" class="message" role="status" aria-live="polite"></div>

      <div id="nameHintForm" class="hint"> <strong>Don't have an account? Contact the admin for an access code.</strong></div>
      <div id="codeHintForm" class="hint"><a href="https://lawreay.github.io/Lawreay-Course-Registration/"><button type="button">Create Account</button></a></div>
    lawrence phuka chikapa
    </form>
  </main>

  <script>
    (function () {
      const COOKIE_NAME = 'invite_verified';
      const LS_KEY = 'invite_token';
      const CACHE_NAME = 'invite-verification-cache';
      const CACHE_KEY = '/invite-verified';

      const form = document.getElementById('inviteForm');
      const nameInput = document.getElementById('name');
      const codeInput = document.getElementById('code');
      const messageEl = document.getElementById('message');
      const clearBtn = document.getElementById('clearBtn');

      function todayString() {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
      }

      function lzwCompressToCodes(input) {
        const dict = new Map();
        for (let i = 0; i < 256; i++) dict.set(String.fromCharCode(i), i);
        let nextCode = 256;
        let w = '';
        const output = [];
        for (let i = 0; i < input.length; i++) {
          const c = input.charAt(i);
          const wc = w + c;
          if (dict.has(wc)) {
            w = wc;
          } else {
            output.push(dict.get(w));
            dict.set(wc, nextCode++);
            w = c;
          }
        }
        if (w !== '') output.push(dict.get(w));
        return output;
      }

      function parseCodeString(s) {
        if (!s) return [];
        const matches = s.match(/\d+/g);
        if (!matches) return [];
        return matches.map(x => parseInt(x, 10));
      }

      function arraysEqual(a, b) {
        if (a.length !== b.length) return false;
        for (let i = 0; i < a.length; i++) if (a[i] !== b[i]) return false;
        return true;
      }

      function makeToken(dateStr, name) {
        const rand = Math.floor(Math.random() * 1e9);
        const raw = `${dateStr}|${name}|${rand}`;
        return btoa(unescape(encodeURIComponent(raw)));
      }

      function setCookieForToday(name, value) {
        const now = new Date();
        const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        const expires = midnight.toUTCString();
        document.cookie = `${encodeURIComponent(name)}=${encodeURIComponent(value)}; expires=${expires}; path=/; SameSite=Lax`;
      }

      async function cacheVerification(token, dateStr) {
        if (!('caches' in window)) return;
        try {
          const cache = await caches.open(CACHE_NAME);
          const body = JSON.stringify({ token, date: dateStr });
          const resp = new Response(body, { headers: { 'Content-Type': 'application/json' } });
          await cache.put(CACHE_KEY, resp);
        } catch (err) {
          console.warn('Cache store failed', err);
        }
      }

      async function storeVerification(token, dateStr) {
        setCookieForToday(COOKIE_NAME, token);
        try { localStorage.setItem(LS_KEY, JSON.stringify({ token, date: dateStr })); } catch (e) {}
        await cacheVerification(token, dateStr);
      }

      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        messageEl.textContent = '';
        messageEl.className = 'message';

        const dateVal = todayString(); 
        const nameVal = nameInput.value.trim();
        const codeRaw = codeInput.value.trim();

        if (!nameVal) { messageEl.textContent = 'Please enter your name.'; messageEl.classList.add('error'); nameInput.focus(); return; }
        if (!codeRaw) { messageEl.textContent = 'Please enter the invitation code.'; messageEl.classList.add('error'); codeInput.focus(); return; }

        const combined = dateVal + nameVal;
        const expectedCodes = lzwCompressToCodes(combined);
        const providedCodes = parseCodeString(codeRaw);

        if (providedCodes.length === 0) { messageEl.textContent = 'No numeric codes found in the invitation code field.'; messageEl.classList.add('error'); codeInput.focus(); return; }

        if (arraysEqual(providedCodes, expectedCodes)) {
          const token = makeToken(dateVal, nameVal);
          await storeVerification(token, dateVal);
          messageEl.textContent = 'Code valid. Redirecting to home…';
          messageEl.classList.add('success');
          setTimeout(() => { window.location.href = 'home.html'; }, 300);
          return;
        }

        const preview = expectedCodes.slice(0, 12).join(', ');
        messageEl.textContent = 'Expected codes start with: ' + preview + (expectedCodes.length > 12 ? ', ...' : '');
        messageEl.classList.add('error');
        codeInput.focus();
      });

      clearBtn.addEventListener('click', function () {
        nameInput.value = '';
        codeInput.value = '';
        messageEl.textContent = '';
        messageEl.className = 'message';
        nameInput.focus();
      });

      (async function checkExistingVerification() {
        try {
          const dateVal = todayString();

          // Check cookie first
          const cookies = document.cookie.split(';').map(c => c.trim());
          const cookieObj = {};
          cookies.forEach(c => {
            const [k, v] = c.split('=');
            if (k) cookieObj[decodeURIComponent(k)] = v ? decodeURIComponent(v) : '';
          });
          const cookieToken = cookieObj[COOKIE_NAME];

          let ls = null;
          try { ls = JSON.parse(localStorage.getItem(LS_KEY)); } catch (e) { ls = null; }

         
          let cacheOk = false;
          if ('caches' in window) {
            try {
              const cache = await caches.open(CACHE_NAME);
              const resp = await cache.match(CACHE_KEY);
              if (resp) {
                const body = await resp.json();
                if (body && body.date === dateVal && body.token) cacheOk = true;
              }
            } catch (err) { /* ignore */ }
          }

          if (cookieToken || (ls && ls.date === dateVal) || cacheOk) {
            messageEl.textContent = 'Already verified for today. Redirecting to home…';
            messageEl.classList.add('success');
            setTimeout(() => { window.location.href = 'home.html'; }, 300);
          }
        } catch (err) {
         
        }
      })();
    })();
  </script>
</body>
</html>

